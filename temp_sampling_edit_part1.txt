<template>
    <div class="page-container">
        <!-- 页面头部 -->
        <div class="page-header">
            <div class="header-left">
                <a-button type="text" @click="handleBack" class="back-button">
                    <template #icon>
                        <ArrowLeftOutlined />
                    </template>
                    返回
                </a-button>
                <div class="title-section">
                    <h2 class="page-title">{{ pageTitle }}</h2>
                    <a-tag v-if="form.samplingMethod" :color="getMethodColor(form.samplingMethod)">
                        {{ getMethodText(form.samplingMethod) }}
                    </a-tag>
                </div>
            </div>
            <div class="header-actions" v-if="!isView">
                <a-button type="primary" @click="handleSave" :loading="saving">保存</a-button>
            </div>
        </div>

        <!-- 基本信息 -->
        <a-card class="form-card" title="基本信息">
            <a-form ref="formRef" :model="form" :rules="rules" layout="horizontal" :label-col="{ span: 6 }"
                :wrapper-col="{ span: 16 }">
                <a-row :gutter="24">
                    <a-col :span="8">
                        <a-form-item label="方案代码" name="planCode">
                            <a-input v-model:value="form.planCode" :disabled="isView || isEdit" placeholder="请输入" />
                        </a-form-item>
                    </a-col>
                    <a-col :span="8">
                        <a-form-item label="方案名称" name="planName">
                            <a-input v-model:value="form.planName" :disabled="isView" placeholder="请输入" />
                        </a-form-item>
                    </a-col>
                    <a-col :span="8">
                        <a-form-item label="抽样方法" name="samplingMethod">
                            <a-select v-model:value="form.samplingMethod" :disabled="isView" placeholder="请选择">
                                <a-select-option value="STANDARD_BASED">国标/标准</a-select-option>
                                <a-select-option value="FIXED_QUANTITY">固定数量</a-select-option>
                                <a-select-option value="PERCENTAGE">百分比</a-select-option>
                                <a-select-option value="FULL_INSPECTION">全检</a-select-option>
                            </a-select>
                        </a-form-item>
                    </a-col>
                </a-row>
                <a-row :gutter="24">
                    <a-col :span="8">
                        <a-form-item label="适用标准" name="standard">
                            <a-input v-model:value="form.standard" :disabled="isView" placeholder="如: GB/T 2828.1" />
                        </a-form-item>
                    </a-col>
                </a-row>
                <a-row :gutter="24">
                    <a-col :span="16">
                        <a-form-item label="描述" name="description" :label-col="{ span: 3 }" :wrapper-col="{ span: 20 }">
                            <a-textarea v-model:value="form.description" :disabled="isView" :rows="2"
                                placeholder="请输入描述" />
                        </a-form-item>
                    </a-col>
                </a-row>
            </a-form>
        </a-card>

        <!-- Tab页签 -->
        <a-card class="tab-card">
            <a-tabs v-model:activeKey="activeTab">
                <!-- 抽样规则Tab -->
                <a-tab-pane key="rules" tab="抽样规则">
                    <div class="tab-toolbar" v-if="!isView">
                        <a-button type="primary" size="small" @click="handleAddRule">
                            <PlusOutlined /> 添加规则
                        </a-button>
                    </div>
                    <a-table :columns="ruleColumns" :data-source="form.rules" row-key="id" size="small"
                        :pagination="false">
                        <template #bodyCell="{ column, record, index }">
                            <template v-if="column.key === 'inspectionLevel'">
                                <a-tag color="blue">{{ record.inspectionLevel }}</a-tag>
                            </template>
                            <template v-else-if="column.key === 'inspectionType'">
                                <a-tag :color="getInspTypeColor(record.inspectionType)">
                                    {{ getInspTypeText(record.inspectionType) }}
                                </a-tag>
                            </template>
                            <template v-else-if="column.key === 'action'">
                                <a-space>
                                    <a-button type="link" size="small" @click="handleEditRule(record)">编辑</a-button>
                                    <a-button v-if="!isView" type="link" danger size="small"
                                        @click="handleRemoveRule(index)">删除</a-button>
                                </a-space>
                            </template>
                        </template>
                        <!-- 嵌套子表格：抽样明细 -->
                        <template #expandedRowRender="{ record }">
                            <div class="detail-table-wrapper">
                                <div class="detail-header">抽样明细 ({{ record.ruleCode }})</div>
                                <a-table :columns="detailColumns" :data-source="record.details" row-key="id"
                                    size="small" :pagination="false" bordered />
                            </div>
                        </template>
                    </a-table>
                    <a-empty v-if="form.rules.length === 0" description="暂无抽样规则，请添加" />
                </a-tab-pane>
            </a-tabs>
        </a-card>

        <!-- 规则编辑弹窗 -->
        <a-modal v-model:visible="ruleModalVisible" :title="isEditRule ? '编辑规则' : '新增规则'" width="700px" @ok="saveRule">
            <a-form layout="vertical" :model="ruleForm">
                <a-row :gutter="16">
                    <a-col :span="12">
                        <a-form-item label="规则代码" required>
                            <a-input v-model:value="ruleForm.ruleCode" />
                        </a-form-item>
                    </a-col>
                    <a-col :span="12">
                        <a-form-item label="规则名称" required>
                            <a-input v-model:value="ruleForm.ruleName" />
                        </a-form-item>
                    </a-col>
                </a-row>
