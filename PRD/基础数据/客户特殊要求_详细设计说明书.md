# 顾客特殊要求(CSR)管理 详细设计说明书

## 1. 文档信息

- **模块名称**：基础数据 / 顾客特殊要求(CSR)管理
- **产品版本**：v1.2.0
- **当前状态**：开发中
- **目标受众**：开发人员、测试人员、实施团队
- **关联模块**：客供关系映射（CTQ标准协同 Tab）、CTQ 参数配置

## 2. 业务背景与目标

### 2.1 问题陈述
在汽车零部件制造的质量管理体系（IATF 16949）中，CTQ（关键质量特性）管理了标准化的技术参数，但对于客户特殊要求（CSR）的管控仍停留在纸面协议：
- **碎片化**：不同客户的 CSR 散落在 PDF 手册、邮件、会议纪要等载体中，缺乏统一管理。
- **依赖人工**：工程师需要"记得"某个客户要求每 500 件做全尺寸检验、质量记录保留 15 年、A类客诉 24 小时内回复 D3 等条款——极易遗忘或遗漏。
- **无法拦截**：即使知道有 CSR 要求，系统也无法在业务流程中自动校验和拦截，导致违规出货、超期回复等风险。

### 2.2 建设目标
1. **结构化解析**：将纸面 CSR 协议分解为可枚举、可追踪的系统条款（Clause）。
2. **流程干预**：通过映射矩阵将条款与 QMS 业务流程节点（IQC/IPQC/OQC/客诉/APQP 等）绑定，在触发条件达成时执行拦截、预警或模板切换等系统动作。
3. **合规可视**：通过看板实时监控全厂 CSR 达成情况，暴露超期和风险项。
4. **CTQ 联动**：将 CTQ 参数配置与 CSR 源条款建立关联关系，当 CSR 协议升级时自动提醒 CTQ 同步更新。

## 3. 核心模型架构

模块采用**三层设计模型**：

```
┌──────────────────────────────────────────────────────────────┐
│  第一层：输入解析层 (Requirement Repository)                    │
│  ─ 管理客户 CSR 协议文件，分解为结构化条款                        │
│  ─ 维护：客户、版本、类型、严格度、标准约束                        │
├──────────────────────────────────────────────────────────────┤
│  第二层：关联映射层 (Process Mapping Matrix)                    │
│  ─ 配置条款与业务流程节点的挂载关系                               │
│  ─ 定义：适用工厂/物料范围、触发条件、执行动作                      │
├──────────────────────────────────────────────────────────────┤
│  第三层：触发执行层 (Automated Action Engine)                   │
│  ─ 部署于业务流程入口的拦截器                                    │
│  ─ 执行：警告拦截、强制锁定、超期计时、模板切换                     │
└──────────────────────────────────────────────────────────────┘
```

## 4. 功能架构设计

本模块包含三大核心子业务，以 Tabs 页签聚合在同一管理入口（`/basic-data/csr-management`）：

1. **CSR 条款维护空间 (Requirement Repository)**
   - 以客户维度管理 CSR 协议源文件及版本。
   - 将协议分解为结构化条款，定义类型、严格度和标准约束。

2. **业务流程映射矩阵 (Process Mapping Matrix)**
   - 配置条款与 QMS 业务流程节点的挂载关系和触发条件。
   - 将静态条款转化为可执行的系统规则。

3. **合规性监控看板 (Compliance Dashboard)**
   - 可视化展示全厂 CSR 达成率、覆盖率、风险告警等指标。

4. **CTQ 标准协同（嵌入客供关系映射 Tab）**
   - 在"客供关系映射"页面的"CTQ标准协同"Tab 中增加"来源 CSR"超链接跳转。
   - CSR 协议版本变更时，在 CTQ 列表顶部弹出联动提醒横幅。

## 5. 页面与交互设计

### 5.1 CSR 条款维护空间

- **操作工具栏**：新增条款、导入（支持 PDF/Word 附件解析）、导出。
- **查询区**：支持按客户名称/条款关键字 + 类型下拉筛选。
- **列表区**：展示客户、版本、类别、严格度（带 Tag 色彩区分）、标准约束、条款描述。
- **操作列**：编辑、配置映射（跳转映射矩阵）、删除（带二次确认）。
- **表单弹窗**（新增/编辑）：
  - **关联客户**：文本输入（后期改为下拉关联客户档案）。
  - **要求版本**：文本输入，格式如 `V2024.1`。
  - **要求类别**：下拉选择（体系要求 / 过程要求 / 交付要求）。
  - **严格度等级**：下拉选择（一般 / 重要 / 强控）。
  - **标准约束**：文本输入（如 `24h`、`15 Years`、`每 500 件`）。
  - **条款内容描述**：多行文本域。
  - **相关附件**：文件上传组件。

### 5.2 业务流程映射矩阵

- **查询区**：支持按物料/工厂/客户/条款关键字搜索。
- **列表区**：展示业务线/工厂、客户代码、适用范围、引用条款协议、干预流程节点、触发条件（紫色 Tag）、执行动作（红/青/橙 Tag）。
- **配置弹窗**：
  - **选择客户**：关联客户实体。
  - **引用条款协议**：级联选择，先选客户后选条款。
  - **干预的业务单据/流程**：下拉选择 QMS 中的触发点（IQC、车间报工、不合格品处置、OQC、APQP/FMEA 文档管理）。
  - **关联物料/产品族**：多选，留空表示适用全部。
  - **触发条件**：文本输入（如"报工数量达到 500"）。
  - **执行动作结果**：下拉（警告并拦截流程 / 自动切换报告模板 / 后台计时及超期预警）。

### 5.3 合规性监控看板

- **指标统计卡片（4张）**：
  - 生效条款总数（蓝色）。
  - 条款覆盖率（绿色，百分比）。
  - 任务按时完成率（黄色，百分比）。
  - 超期/告警风险项（红色，绝对数）。
- **CSR 达成率监控趋势（折线+柱状复合图）**：
  - 左 Y 轴：条款覆盖率 & 任务按时完成率（折线，平滑曲线+面积填充）。
  - 右 Y 轴：外审发现点（柱状图）。
  - X 轴：按月展示近半年数据。
- **条款类型分布（环形饼图）**：
  - 体系要求 / 过程要求 / 交付要求 的数量占比。
  - 圆角扇区 + 标签显示百分比。
- **实时风险告警列表**：
  - 字段：客户、条款描述、严格度、触发条件、状态（超期/即将触发/即将到期）、剩余时间。
  - 支持穿透到相关业务单据。

### 5.4 CTQ 标准协同 — CSR 联动增强（嵌入客供关系映射页面）

- **CSR 版本联动提醒横幅**：
  - 在 CTQ 标准协同 Tab 顶部，当检测到关联的 CSR 协议版本升级时，展示黄色 `a-alert` 提醒条。
  - 内容："客户 **{客户名}** 的 CSR 协议已从 `旧版本` 更新至 `新版本`，请核对并同步更新以下 CTQ 参数阈值。"
  - 提供"查看受影响的 CTQ →"快捷链接，点击自动过滤。
- **"来源 CSR"列**：
  - 表格新增"来源 CSR"列，显示为蓝色超链接。点击后路由跳转至 `/basic-data/csr-management`。
  - 未关联的 CTQ 显示灰色"未关联"。
- **"CSR 版本"列**：
  - 绿色 Tag 表示版本一致。红色 Tag + ⚠ 叹号图标表示版本已过时。
  - 鼠标悬停显示 Tooltip："CSR 协议版本已更新，请核查本项参数"。
- **CTQ 详情弹窗增强**：
  - 底部新增"来源 CSR"描述行，含超链接跳转、版本号 Tag 和过期警告文字。

## 6. 数据模型设计

### 6.1 实体关系概览

```
qms_csr_protocol (协议主表)
    │
    ├── 1:N ──→ qms_csr_clause (条款明细表)
    │               │
    │               └── 1:N ──→ qms_csr_process_mapping (业务流程映射表)
    │                               │
    │                               └── 1:N ──→ qms_csr_trigger_log (触发执行记录表)
    │
    └── 1:N ──→ qms_csr_protocol_attachment (协议附件表)

qms_ctq_mapping (已有CTQ映射表)
    │
    └── N:1 ──→ qms_csr_clause (通过 csr_clause_id 外键关联)
```

### 6.2 CSR 协议主表（`qms_csr_protocol`）

**说明**：记录各个客户不同版本的 CSR 协议声明或合同。一个客户可拥有多个版本的协议。

| 字段名称     | 物理字段名      | 数据类型      | 约束            | 描述说明                                    |
| :----------- | :-------------- | :------------ | :-------------- | :------------------------------------------ |
| 主键ID       | `id`            | VARCHAR(64)   | PK              | 唯一标识                                    |
| 租户ID       | `tenant_id`     | VARCHAR(64)   | INDEX           | 多租户隔离                                  |
| 客户ID       | `customer_id`   | VARCHAR(64)   | NOT NULL, INDEX | 关联客户档案表(`qms_customer`)主键           |
| 协议编号     | `protocol_no`   | VARCHAR(50)   | NOT NULL, UQ    | 协议唯一编号                                |
| 版本号       | `version`       | VARCHAR(20)   | NOT NULL        | 版本号 (如 V1.0, V2024.1)                   |
| 状态         | `status`        | VARCHAR(20)   | DEFAULT 'DRAFT' | DRAFT=草稿, ACTIVE=生效中, ARCHIVED=已归档  |
| 生效日期     | `valid_from`    | DATE          | NOT NULL        | 协议生效起始日期                            |
| 失效日期     | `valid_to`      | DATE          |                 | 协议失效日期（空=长期有效）                  |
| 协议摘要     | `summary`       | VARCHAR(500)  |                 | 协议整体概要描述                            |
| 创建人       | `create_by`     | VARCHAR(64)   |                 | 创建者ID                                    |
| 创建时间     | `create_time`   | DATETIME      | DEFAULT NOW()   | 记录创建时间                                |
| 更新人       | `update_by`     | VARCHAR(64)   |                 | 更新者ID                                    |
| 更新时间     | `update_time`   | DATETIME      |                 | 记录更新时间                                |
| 逻辑删除标记 | `deleted`       | TINYINT(1)    | DEFAULT 0       | 0=正常, 1=已删除                            |

**索引设计**：
- `idx_protocol_customer`: (`tenant_id`, `customer_id`)
- `idx_protocol_status`: (`tenant_id`, `status`)
- `uq_protocol_no`: (`tenant_id`, `protocol_no`) UNIQUE

### 6.3 协议附件表（`qms_csr_protocol_attachment`）

**说明**：存储与 CSR 协议关联的附件文件信息（PDF/Word 等原始手册）。

| 字段名称     | 物理字段名       | 数据类型      | 约束            | 描述说明                         |
| :----------- | :--------------- | :------------ | :-------------- | :------------------------------- |
| 主键ID       | `id`             | VARCHAR(64)   | PK              | 唯一标识                         |
| 协议ID       | `protocol_id`    | VARCHAR(64)   | NOT NULL, INDEX | 关联 `qms_csr_protocol.id`       |
| 文件名称     | `file_name`      | VARCHAR(200)  | NOT NULL        | 原始文件名                       |
| 文件路径     | `file_path`      | VARCHAR(500)  | NOT NULL        | 文件存储路径或对象存储 Key       |
| 文件大小     | `file_size`      | BIGINT        |                 | 文件大小（字节）                 |
| 文件类型     | `file_type`      | VARCHAR(20)   |                 | 文件 MIME 类型（pdf/docx 等）    |
| 上传人       | `upload_by`      | VARCHAR(64)   |                 | 上传者ID                         |
| 上传时间     | `upload_time`    | DATETIME      | DEFAULT NOW()   | 上传时间                         |

### 6.4 协议条款明细表（`qms_csr_clause`）

**说明**：将 CSR 协议源文件拆解为结构化、原子化、可追踪的业务约束条款。每条协议可拥有多个条款。

| 字段名称       | 物理字段名        | 数据类型       | 约束              | 描述说明                                             |
| :------------- | :---------------- | :------------- | :---------------- | :--------------------------------------------------- |
| 主键ID         | `id`              | VARCHAR(64)    | PK                | 唯一标识                                             |
| 协议ID         | `protocol_id`     | VARCHAR(64)    | NOT NULL, INDEX   | 关联 `qms_csr_protocol.id`                           |
| 条款编号       | `clause_no`       | VARCHAR(30)    | NOT NULL          | 条款序号或编码（如 CSR-001）                         |
| 要求类别       | `req_type`        | VARCHAR(30)    | NOT NULL          | SYSTEM=体系要求, PROCESS=过程要求, DELIVERY=交付要求 |
| 严格度等级     | `severity_level`  | VARCHAR(20)    | DEFAULT 'NORMAL'  | NORMAL=一般, IMPORTANT=重要, CRITICAL=强控           |
| 标准约束       | `standard_value`  | VARCHAR(100)   |                   | 提取的核心阈值（如 24h, 15Years, 500pcs, 100%）      |
| 条款描述       | `description`     | VARCHAR(2000)  | NOT NULL          | 条款具体的原始业务描述文本                           |
| 显示排序       | `sort_order`      | INT            | DEFAULT 0         | 列表排序                                             |
| 状态           | `status`          | VARCHAR(20)    | DEFAULT 'ACTIVE'  | ACTIVE=生效, DISABLED=停用                           |
| 创建人         | `create_by`       | VARCHAR(64)    |                   | 创建者ID                                             |
| 创建时间       | `create_time`     | DATETIME       | DEFAULT NOW()     | 记录创建时间                                         |
| 更新人         | `update_by`       | VARCHAR(64)    |                   |                                                      |
| 更新时间       | `update_time`     | DATETIME       |                   |                                                      |

**索引设计**：
- `idx_clause_protocol`: (`protocol_id`)
- `idx_clause_type_severity`: (`req_type`, `severity_level`)

### 6.5 业务流程映射矩阵表（`qms_csr_process_mapping`）

**说明**：定义 CSR 条款应该在何时(When)、在何处(Where)、针对什么范围(Scope)、执行何种动作(Action)的系统逻辑配置。每条条款可挂载多条映射规则。

| 字段名称         | 物理字段名          | 数据类型      | 约束            | 描述说明                                                                 |
| :--------------- | :------------------ | :------------ | :-------------- | :----------------------------------------------------------------------- |
| 主键ID           | `id`                | VARCHAR(64)   | PK              | 唯一标识                                                                 |
| 条款ID           | `clause_id`         | VARCHAR(64)   | NOT NULL, INDEX | 关联 `qms_csr_clause.id`                                                 |
| 工厂组织ID       | `factory_id`        | VARCHAR(64)   | NOT NULL, INDEX | 适用的工厂/组织 ID                                                       |
| 物料范围类型     | `material_scope_type`| VARCHAR(20)  | DEFAULT 'ALL'   | ALL=全部, CATEGORY=按分类, SPECIFIC=指定物料                             |
| 物料范围值       | `material_scope_val`| JSON          |                 | 具体的物料分类 ID 或物料 ID 数组 (JSON Array)                            |
| 业务节点         | `business_node`     | VARCHAR(50)   | NOT NULL        | 被干预的 QMS 业务节点枚举：IQC_INSPECTION, PROCESS_REPORT, CUSTOMER_COMPLAINT, OQC_INSPECTION, DOC_CONTROL |
| 触发条件         | `trigger_condition` | VARCHAR(500)  |                 | 触发条件表达式（SpEL / JSON 格式供引擎解析）                             |
| 触发条件描述     | `trigger_desc`      | VARCHAR(200)  |                 | 面向用户的触发条件自然语言描述                                           |
| 执行动作类型     | `action_type`       | VARCHAR(30)   | NOT NULL        | BLOCK=警告拦截, SWITCH_TEMPLATE=切换模板, START_TIMER=超期计时预警       |
| 执行动作参数     | `action_params`     | JSON          |                 | 动作附加参数（如模板ID、SLA时长等）                                      |
| 是否启用         | `is_active`         | TINYINT(1)    | DEFAULT 1       | 1=启用, 0=停用                                                          |
| 创建人           | `create_by`         | VARCHAR(64)   |                 | 创建者ID                                                                 |
| 创建时间         | `create_time`       | DATETIME      | DEFAULT NOW()   |                                                                          |
| 更新人           | `update_by`         | VARCHAR(64)   |                 |                                                                          |
| 更新时间         | `update_time`       | DATETIME      |                 |                                                                          |

**关键枚举说明**：

`business_node` 枚举值：

| 枚举值                | 含义              | 典型触发场景                     |
| :-------------------- | :---------------- | :------------------------------- |
| IQC_INSPECTION        | 来料检验单        | 来料送检时检查是否符合特殊要求   |
| PROCESS_REPORT        | 车间报工/过程检验 | 报工数量累计达到阈值时触发       |
| CUSTOMER_COMPLAINT    | 不合格品处置/客诉 | 客诉单创建时启动 SLA 计时        |
| OQC_INSPECTION        | 出货检验          | 出货审核时校验强控项是否全部通过 |
| DOC_CONTROL           | APQP/FMEA文档管理 | 新建质量记录时标记保留期限       |

`action_type` 枚举值：

| 枚举值           | 含义            | 执行效果                                                   |
| :--------------- | :-------------- | :--------------------------------------------------------- |
| BLOCK            | 警告拦截        | 阻断当前业务操作，强控项（CRITICAL）锁定出货               |
| SWITCH_TEMPLATE  | 切换模板        | 强制当前检验单加载指定的客户专用检验模板                   |
| START_TIMER      | 超期计时预警    | 后台启动倒计时，到期未完成则升级告警或锁定流程             |

**索引设计**：
- `idx_mapping_clause`: (`clause_id`)
- `idx_mapping_factory_node`: (`factory_id`, `business_node`)
- `idx_mapping_active`: (`is_active`)

### 6.6 触发与执行记录表（`qms_csr_trigger_log`）

**说明**：记录管控引擎在实际业务流中的触发命中日志。用于合规看板的达成率计算、告警列表展示、以及外审证据追溯。

| 字段名称         | 物理字段名         | 数据类型      | 约束            | 描述说明                                                     |
| :--------------- | :----------------- | :------------ | :-------------- | :----------------------------------------------------------- |
| 主键ID           | `id`               | VARCHAR(64)   | PK              | 唯一标识                                                     |
| 映射规则ID       | `mapping_id`       | VARCHAR(64)   | NOT NULL, INDEX | 关联 `qms_csr_process_mapping.id`                             |
| 业务单据号       | `business_bill_no` | VARCHAR(50)   | NOT NULL        | 触发该动作的具体业务单据号（客诉单号、IQC单号等）            |
| 业务单据类型     | `business_bill_type`| VARCHAR(30)  | NOT NULL        | 单据类型枚举（与 business_node 对应）                        |
| 触发时间         | `trigger_time`     | DATETIME      | DEFAULT NOW()   | 引擎命中规则的时间                                           |
| 执行动作         | `action_executed`  | VARCHAR(30)   | NOT NULL        | 实际执行的动作类型                                           |
| 动作执行结果     | `action_result`    | VARCHAR(50)   | NOT NULL        | TRIGGERED_BLOCK=拦截生效, TIMER_STARTED=计时已启动, WARNING_SENT=警告已发出 |
| 最晚达成时间     | `deadline_time`    | DATETIME      |                 | 针对计时类控制：最晚要求完成时间                             |
| 实际完成时间     | `close_time`       | DATETIME      |                 | 实际任务闭环完成时间                                         |
| 是否违规         | `is_violated`      | TINYINT(1)    | DEFAULT 0       | 0=正常达成, 1=违规（超期或未通过），用于计算达成率           |
| 操作人           | `operator`         | VARCHAR(64)   |                 | 触发时的操作人                                               |
| 备注             | `remark`           | VARCHAR(500)  |                 | 处理说明或超期原因                                           |

**索引设计**：
- `idx_trigger_mapping`: (`mapping_id`)
- `idx_trigger_time`: (`trigger_time`)
- `idx_trigger_violated`: (`is_violated`)
- `idx_trigger_bill`: (`business_bill_no`, `business_bill_type`)

### 6.7 已有 CTQ 映射表改造（`qms_ctq_mapping` 增加字段）

**说明**：在已有的 CTQ 特性标准映射表中，新增以下字段以建立与 CSR 条款的关联关系。

| 新增字段名称       | 物理字段名          | 数据类型     | 约束   | 描述说明                                       |
| :----------------- | :------------------ | :----------- | :----- | :--------------------------------------------- |
| CSR条款ID          | `csr_clause_id`     | VARCHAR(64)  | INDEX  | 关联 `qms_csr_clause.id`（可为空=未关联CSR）   |
| CSR协议版本快照    | `csr_version_snapshot`| VARCHAR(20)|        | 关联当时的 CSR 协议版本号，用于版本比对提醒     |

**版本联动逻辑**：
- 后端定时任务/协议版本变更事件触发后，查询所有 `csr_clause_id` 不为空的 CTQ 记录。
- 比对 `csr_version_snapshot` 与当前协议最新 `version`，若不一致则标记为"版本过时"。
- 前端在 CTQ 列表顶部展示黄色提醒横幅。

## 7. 核心接口设计 (API)

### 7.1 CSR 协议管理 API
| 方法   | 路径                                            | 描述               |
| :----- | :---------------------------------------------- | :----------------- |
| GET    | `/api/v1/csr/protocols`                         | 获取协议列表（分页）|
| POST   | `/api/v1/csr/protocols`                         | 创建协议           |
| PUT    | `/api/v1/csr/protocols/{id}`                    | 更新协议           |
| DELETE | `/api/v1/csr/protocols/{id}`                    | 删除协议（逻辑删除）|
| POST   | `/api/v1/csr/protocols/{id}/attachments`        | 上传附件           |

### 7.2 CSR 条款管理 API
| 方法   | 路径                                            | 描述                 |
| :----- | :---------------------------------------------- | :------------------- |
| GET    | `/api/v1/csr/protocols/{protocolId}/clauses`    | 获取协议下所有条款   |
| POST   | `/api/v1/csr/clauses`                           | 创建条款             |
| PUT    | `/api/v1/csr/clauses/{id}`                      | 更新条款             |
| DELETE | `/api/v1/csr/clauses/{id}`                      | 删除条款             |

### 7.3 业务流程映射 API
| 方法   | 路径                                            | 描述                   |
| :----- | :---------------------------------------------- | :--------------------- |
| GET    | `/api/v1/csr/process-mappings`                  | 获取映射矩阵列表       |
| POST   | `/api/v1/csr/process-mappings`                  | 创建映射规则           |
| PUT    | `/api/v1/csr/process-mappings/{id}`             | 更新映射规则           |
| PATCH  | `/api/v1/csr/process-mappings/{id}/toggle`      | 启用 / 停用映射规则     |

### 7.4 合规性看板 API
| 方法   | 路径                                            | 描述                             |
| :----- | :---------------------------------------------- | :------------------------------- |
| GET    | `/api/v1/csr/dashboard/stats`                   | 获取统计卡片数据                 |
| GET    | `/api/v1/csr/dashboard/trend`                   | 获取达成率趋势图数据（按月）     |
| GET    | `/api/v1/csr/dashboard/distribution`            | 获取条款类型分布数据             |
| GET    | `/api/v1/csr/dashboard/alerts`                  | 获取当前风险告警列表             |

### 7.5 引擎执行 API（内部调用）
| 方法   | 路径                                            | 描述                                       |
| :----- | :---------------------------------------------- | :----------------------------------------- |
| POST   | `/api/v1/csr/engine/evaluate`                   | 业务流程入口拦截判定（内部RPC）             |
| GET    | `/api/v1/csr/trigger-logs`                      | 获取触发记录（带分页和过滤）               |

### 7.6 CTQ-CSR 联动 API（扩展已有接口）
| 方法   | 路径                                            | 描述                                       |
| :----- | :---------------------------------------------- | :----------------------------------------- |
| GET    | `/api/v1/ctq-mappings/csr-version-alerts`       | 获取 CSR 版本变更提醒列表                   |
| PUT    | `/api/v1/ctq-mappings/{id}/csr-link`            | 更新 CTQ 的 CSR 来源关联                    |

## 8. 引擎执行方案

### 8.1 统一拦截接口
后端所有关键业务方法（提交报工、提交出货审核、提交客诉回复等）引入 `CsrActionEngine.evaluate(context)` 拦截点。

### 8.2 上下文组装
```java
CsrEvaluationContext context = CsrEvaluationContext.builder()
    .customerId("C001")
    .materialId("M001")
    .factoryId("F001")
    .businessNode(BusinessNode.OQC_INSPECTION)
    .businessBillNo("OQC-20260226-001")
    .additionalParams(Map.of("quantity", 500))
    .build();
```

### 8.3 引擎处理链路
1. **规则过滤**：查询 `qms_csr_process_mapping` 中符合工厂、客户、物料且 `is_active=1` 的规则集合。
2. **条件求值**：解析 `trigger_condition` 表达式，结合上下文参数判定是否命中。
3. **动作分发**：
   - `BLOCK` + `CRITICAL`：抛出强控异常，前端阻断提交，写入 trigger_log。
   - `SWITCH_TEMPLATE`：返回需挂载的模板 ID 给前端动态渲染。
   - `START_TIMER`：投递延时消息进消息队列，写入 trigger_log 的 `deadline_time`。

### 8.4 初版策略模板（简化实现）
初版引擎采用硬编码的策略模板降低复杂度：

| 策略模板             | 触发条件参数         | 动作参数                |
| :------------------- | :------------------- | :---------------------- |
| 时间限制类           | SLA时长（小时）      | 超期后升级邮件/红灯     |
| 频次触发类           | 累积数量阈值         | 拦截出货/触发全检       |
| 文件模板类           | 无（节点触发即生效） | 目标模板 ID             |

后期再扩展更自由的规则引擎（如支持 SpEL 表达式）。

## 9. 权限与安全说明

1. **功能权限**：
   - CSR 条款增、删、改需具有"基础数据:CSR管理:编辑"角色权限。
   - 映射规则启用/停用需具有"基础数据:CSR管理:配置"角色权限。
   - 合规看板为只读视图，仅需"基础数据:CSR管理:查看"权限。
2. **数据权限**：
   - 使用 `tenant_id` 进行 SaaS 多租户数据隔离。
   - 工厂维度配置的映射规则，仅对该工厂组织下的用户可见。
3. **安全规范**：
   - 附件上传需校验文件类型白名单（PDF、DOCX、XLSX），限制单文件最大 20MB。
   - `trigger_condition` 表达式执行需在沙箱环境中解析，防止注入风险。

## 10. 前端目录结构

```
src/views/basic-data/csr-management/
├── index.vue                              # 主入口：Tabs 容器
└── components/
    ├── RequirementRepository.vue           # Tab1: CSR 条款维护空间
    ├── ProcessMappingMatrix.vue            # Tab2: 业务流程映射矩阵
    └── ComplianceDashboard.vue             # Tab3: 合规性监控看板

src/views/basic-data/CustomerSupplierMapping.vue
└── Tab2: CTQ标准协同 (已内嵌 CSR 来源关联 + 版本联动提醒)
```

## 11. 路由与菜单配置

| 路由路径                         | 组件                                   | 菜单位置           |
| :------------------------------- | :------------------------------------- | :----------------- |
| `/basic-data/csr-management`     | `csr-management/index.vue`             | 基础数据 → 顾客特殊要求(CSR) |
| `/basic-data/customer-supplier-mapping` | `CustomerSupplierMapping.vue`    | 基础数据 → 客供关系映射 (已有) |
