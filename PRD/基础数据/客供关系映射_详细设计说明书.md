# 客供关系映射 详细设计说明书

## 1. 文档信息

- **模块名称**：基础数据 / 客供关系映射
- **产品版本**：v1.1.0
- **当前状态**：设计中
- **目标受众**：开发人员、测试人员、实施团队

## 2. 业务背景与目标

在制造业供应链质量协同管理（SQM/CQM）中，客户、企业内部、供应商三方的系统经常处于独立运转状态，导致物料编码、质量标准名称、追溯批次等信息出现“各说各话”的孤岛现象。

本模块的核心目标是：
1. **打破数据孤岛**：建立跨企业边界的数据对照与翻译机制。
2. **全生命周期追溯**：将客户物料打通内部系统再延伸至源头供应商，实现“客户 -> 成品 -> 工序 -> 原材料 -> 供应商”的端到端正反向追溯。
3. **统一质量语言**：将客户特殊要求（CTQ）等外部标准映射为内部可执行、可检验的标准化检验项目（Inspection Item）。

## 3. 功能架构设计

本模块包含三大核心子业务：

1. **物料编码映射（双向）**
   - 实现外部系统物料编码（客户/供应商）与内部 QMS 标准物料编码的绑定。
2. **CTQ标准协同**
   - 实现客户特殊特性（CC/SC/一般特性）与内部质量检验标准的同步关联。
3. **追溯关系配置**
   - 定义产品从供应商原材料经过各生产工序直至交付客户的逻辑追溯链路图。

## 4. 页面与交互设计

页面采用“左侧条件过滤+右侧数据操作”或直接使用“Tabs页签切换”的设计模式。已采用 `Tabs页签` 的结构将三个子业务有效隔离并聚合在一个管理入口内。

### 4.1 Tab 1：物料编码映射
- **查询区**：支持按客户/供应商、外部物料编码、内部物料编码、状态进行筛选。
- **列表区**：展示映射方向、客供名称、外部编码名称、内部编码名称及状态。
- **操作区**：支持新增、编辑、查看、批量启用/禁用及单个/批量删除功能。
- **表单设计**：
  - **映射方向**：单选（客户方向 / 供应商方向）。
  - **客户/供应商**：下拉选择（带搜索过滤）。
  - **外部物料/名称**：文本输入（对接系统的外部物料唯一标识）。
  - **内部标准物料**：下拉选择内部物料库数据。
  - **状态/备注**：启用禁用开关及详情备注。

### 4.2 Tab 2：CTQ 标准协同
- **查询区**：支持按客户名称、CTQ 特性名称检索。
- **列表区**：展示客户名称、CTQ 特性、严重等级（关键、重要、一般）、关联的内部物料及检验项、标准描述及同步状态。
- **操作区**：支持同步（一键将CTQ生成为内部检验方案的检验项目）和详细查看。

### 4.3 Tab 3：追溯关系配置
- **查询区**：按成品物料、客户名称搜索。
- **列表区**：展示产品全链路追溯路径。以组件（例：`a-steps`）直观呈现：`供应商` -> `原材料` -> `生产工序` -> `成品` -> `客户`的层级关系。
- **操作区**：支持可视化追溯链路查看与编辑追溯链配置。

## 5. 数据模型设计

为了支撑上述业务功能，数据库需要设计以下相关的物理表。

### 5.1 物料编码映射表（`qms_material_mapping`）

**说明**：用于存储外部单位（客户或供应商）物料信息与内部标准物料档案的对照关系。

| 字段名称 | 物理字段名 | 数据类型 | 约束 | 描述说明 |
| :--- | :--- | :--- | :--- | :--- |
| 主键ID | `id` | VARCHAR(64) | PK | 唯一标识 |
| 租户ID | `tenant_id` | VARCHAR(64) | INDEX | 多租户隔离 |
| 映射方向 | `direction` | VARCHAR(20) | NOT NULL | `customer`=客户方向; `supplier`=供应商方向 |
| 客供ID | `partner_id` | VARCHAR(64) | INDEX | 关联客供关系档案表主键 |
| 外部物料编码 | `external_code` | VARCHAR(100) | NOT NULL | 外部系统物料编码 |
| 外部物料名称 | `external_name` | VARCHAR(200) | | 外部系统物料名称 |
| 内部物料ID | `internal_material_id` | VARCHAR(64) | INDEX | 关联基础数据-内部物料表主键 |
| 状态 | `status` | VARCHAR(10) | DEFAULT '1' | `1`=启用, `0`=禁用 |
| 备注说明 | `remark` | VARCHAR(500) | | 备注 |
| 创建人 | `create_by` | VARCHAR(64) | | 创建者ID |
| 创建时间 | `create_time` | DATETIME | | 记录创建时间 |
| 更新人 | `update_by` | VARCHAR(64) | | 更新者ID |
| 更新时间 | `update_time` | DATETIME | | 记录更新时间 |

### 5.2 CTQ特性标准映射表（`qms_ctq_mapping`）

**说明**：存储接收到的客户特殊要求，并记录其与系统内部质检模型的匹配状态。

| 字段名称 | 物理字段名 | 数据类型 | 约束 | 描述说明 |
| :--- | :--- | :--- | :--- | :--- |
| 主键ID | `id` | VARCHAR(64) | PK | 唯一标识 |
| 客户ID | `customer_id` | VARCHAR(64) | INDEX | 关联客户档案主键 |
| 关联物料ID | `material_id` | VARCHAR(64) | INDEX | 受影响的产品物料主键 |
| CTQ特性名称 | `ctq_name` | VARCHAR(100) | NOT NULL | 客户方定义的特性名称 |
| 严重等级 | `severity` | VARCHAR(20) | NOT NULL | `critical`=关键(CC), `major`=重要(SC), `minor`=一般 |
| 标准及要求描述| `standard_desc` | TEXT | | 客户提供的公差或检验标准 |
| 内部检验项ID | `insp_item_id` | VARCHAR(64) | INDEX | 映射到的内部检验项ID (可为空) |
| 同步状态 | `sync_status` | VARCHAR(20) | DEFAULT 'pending'| `pending`=待同步, `synced`=已同步 |
| 创建人 | `create_by` | VARCHAR(64) | | 创建者ID |
| 创建时间 | `create_time` | DATETIME | | |

### 5.3 全链路追溯节点配置表（`qms_traceability_link`）

**说明**：用于配置一条产品的宏观追溯依赖链条，供业务追踪展示及正反向检索时使用。

| 字段名称 | 物理字段名 | 数据类型 | 约束 | 描述说明 |
| :--- | :--- | :--- | :--- | :--- |
| 主键ID | `id` | VARCHAR(64) | PK | 唯一标识 |
| 客户ID | `customer_id` | VARCHAR(64) | INDEX | 交付对象（客户） |
| 成品物料ID | `product_material_id` | VARCHAR(64) | INDEX | 最终交付成品 |
| 关联生产工序ID| `process_route_id` | VARCHAR(64) | INDEX | 生产流转路径/工艺 |
| 原材料物料ID | `raw_material_id` | VARCHAR(64) | INDEX | 主要追溯的原材料 |
| 供应商ID | `supplier_id` | VARCHAR(64) | INDEX | 原材料供应商 |
| 配置状态 | `status` | VARCHAR(10) | DEFAULT '1' | `1`=有效, `0`=失效 |
| 数据版本号 | `version` | INT | DEFAULT 1 | 乐观锁及配置变更版本控制 |

## 6. 核心接口设计 (API)

### 6.1 物料编码映射 API
- **获取映射分页列表**：`GET /api/v1/basic-data/material-mappings`
- **创建物料映射**：`POST /api/v1/basic-data/material-mappings`
- **更新物料映射**：`PUT /api/v1/basic-data/material-mappings/{id}`
- **删除物料映射**：`DELETE /api/v1/basic-data/material-mappings/{id}`
- **批量更新状态**：`PATCH /api/v1/basic-data/material-mappings/status`

### 6.2 CTQ 与检验标准 API
- **获取CTQ列表**：`GET /api/v1/basic-data/ctq-mappings`
- **执行CTQ标准同步**：`POST /api/v1/basic-data/ctq-mappings/{id}/sync`
  - *逻辑描述*：将 CTQ 标准快速写入检验项目库（Insp Item），并将生成的 `insp_item_id` 回写至本表，状态置为 `synced`。

### 6.3 追溯关系 API
- **获取追溯配置连列表**：`GET /api/v1/basic-data/traceability-links`
- **获取某个成品的完整追溯视图**：`GET /api/v1/basic-data/traceability-links/view/{productMaterialId}`

## 7. 权限与安全说明

1. **功能权限**：
   - 客户维度的配置需校验用户是否具有“客诉管理/客户协同”模块权限。
   - 供应商维度的配置需校验用户是否具有“供应商管理(SQM)”模块操作权限。
2. **数据权限**：
   - 使用 `tenant_id` 进行 SaaS 多租户数据隔离。
   - 表单中所有涉及外部传参处，应对 `internal_material_id` 以及 `partner_id` 的合法性及其当前业务状态（是否停用）进行数据强校验，避免脏数据写入。
