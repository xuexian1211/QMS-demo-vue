# 抽样方案管理 (Sampling Plan) - 详细设计文档

## 1. 模块概述
**模块名称**：AQL 抽样规则与方案 (Sampling Plan)
**所属子系统**：质量主数据模块 (Quality Master Data)
**目标**：定义复杂的批量到样本转换计算规则，支持国际通用标准(如 GB/T 2828.1) 和内控百分比或全检方式，决定各检测批次放行和拒收 (Ac/Re) 阀值的底层模型。

## 2. 界面布局与交互设计 
### 2.1 深度的 “左菜单右详情” 经典布局
页面为了适应多规则子级的渲染，构建了类似 IDE 的导航框架配置模式：
- **左侧边栏 (Left Panel)**：主方案导航。
  - 列出包含 GB/T2828.1 或 百分比 等大类母方案。
  - 含有悬浮快捷键及过滤功能，点击卡片（支持选中底色高亮）可以异步加载对应大类的诸多规则。
- **右侧工作台 (Right Panel)**：规则矩阵与详细子表展示区。
  - 结合主大类显示 `planCode`，可以向该方案下派生增添 “规则 (Rules)”。
  - 以 `Nested Table` 嵌套表格形式渲染不同规则组合下的判定细则。

## 3. 核心功能设计
### 3.1 丰富的抽样标准匹配策略
支持由业务枚举定义的抽样模型 (`samplingMethod`)：
- **STANDARD_BASED**: 国标/行业计算判定 (使用 AQL 查询矩阵)
- **FIXED_QUANTITY**: 强制固定抽样个数 (例如来多少固定抽 10 件)
- **PERCENTAGE**: 百分比折算量 (例如10%)
- **FULL_INSPECTION**: 全检 (100%覆盖)

### 3.2 矩阵抽样明细规则网格
这是本页面的主要亮点组件，用于渲染 AQL 规则的核心精髓：
针对给定的 `inspectionLevel` (检验等级如：II、S1、S2) 和 `inspectionType` (类型如正常、加严、放宽)：
配置一个批量查询表格。例如：
- 当交收数量段在 `[batchSizeMin, batchSizeMax]` 间。
- 采用某字码 (`sampleSizeCode`)，确定应取样总数。
- 然后配置 `Ac（接收阀值数量）` 和 `Re（拒收阈值）`。系统将以此矩阵精确执行批次判断逻辑。

## 4. 数据模型 (Data Model)
数据结构上为 方案主干 -> 子规则设定 -> 阈值明细段 的三级树状体系：

**Plan 层 (`SamplingPlan`)**:
- `id`, `orgId`
- `planCode`, `planName`
- `samplingMethod`: （国标、固定数、百分比等算法）
- `description`

**Rule 层 (与Plan为 1:N)**:
- `ruleCode`, `ruleName`
- `inspectionLevel`: (I, II, III级等)
- `inspectionType`: (正常/加严/放宽)
- `aqlValue`: (0.65, 1.0, 1.5, 等)

**Detail 层 (批量到样本矩阵段，与Rule为 1:N)**:
- `batchSizeMin`, `batchSizeMax`
- `sampleSizeCode`: 样本容量指示符字母
- `acceptanceNumber` (Ac)
- `rejectionNumber` (Re)

## 5. 约束与规则
- **规则交叉检查**：对于同一个检验级别、检验类型和 AQL 下的 `[batchSizeMin, batchSizeMax]` 交收批次范围，不应该有任何覆盖或断层死角的重叠空间。
- **关联锁定限制**：在部分业务场景下，如果一个 AQL 方案或其中的规则已经被业务检验任务直接或间接作为计算快照锁定使用，不能执行删去（Delete），仅能采取废弃挂起动作。
