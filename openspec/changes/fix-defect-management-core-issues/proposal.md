# Change: 修复质量主数据不良现象和不良原因核心缺陷

## Why

当前质量主数据的不良现象和不良原因管理功能存在严重缺陷，与需求文档（`insp_main_data_req.md` 第四部分）的符合度仅为 65%。主要问题包括：

1. **多组织支持缺失** - 所有表缺少 `orgId` 字段，无法区分集团级和工厂级数据
2. **不良原因树状结构缺失** - 缺少 `parentId` 字段，无法支持多层级原因分析（5Why 方法）
3. **高频原因推荐功能缺失** - 缺少 `isHighFrequency` 字段，无法实现智能推荐

这些缺陷导致系统无法满足多工厂场景、无法进行深度根因分析、无法积累和复用质量知识库，严重影响系统的实用性和可扩展性。

本次变更采用**最小修复方案**，专注于修复上述三个严重问题，确保核心功能符合需求，为快速上线做准备。

## What Changes

### 1. 数据模型修改

#### 1.1 缺陷分类表 (DefectCategory)
- ✨ 新增 `orgId?: number` 字段 - 支持多组织（NULL 表示集团级）
- 🔧 修改唯一性约束为 `orgId + categoryCode`

#### 1.2 不良现象表 (DefectPhenomenon)
- ✨ 新增 `orgId?: number` 字段 - 支持多组织
- 🔧 修改唯一性约束为 `orgId + code`

#### 1.3 不良原因表 (DefectCause)
- ✨ 新增 `orgId?: number` 字段 - 支持多组织
- ✨ 新增 `parentId?: number` 字段 - 支持树状结构（多层级原因）
- ✨ 新增 `isHighFrequency: boolean` 字段 - 标记高频原因
- 🔧 修改唯一性约束为 `orgId + code`

#### 1.4 现象-原因知识库 (PhenomenonCauseMapping)
- ✨ 新增 `orgId: number` 字段 - 支持多组织知识库
- ✨ 新增 `weight: number` 字段 - 记录发生频率/权重

### 2. 前端页面修改

#### 2.1 缺陷分类管理
- 🔧 表单增加组织选择器（可选，NULL 表示集团级）
- 🔧 列表显示组织信息
- 🔧 树节点显示组织标识

#### 2.2 不良现象管理 (DefectPhenomenonList.vue)
- 🔧 表单增加组织选择器
- 🔧 列表显示组织信息
- 🔧 筛选支持按组织过滤

#### 2.3 不良原因管理 (DefectCauseList.vue)
- ✨ **重构左侧树** - 从简单分类改为真正的原因层级树
- ✨ 支持添加子原因（实现 parentId 关联）
- ✨ 表单增加"高频原因"开关
- ✨ 列表显示高频标记（⭐图标）
- 🔧 表单增加组织选择器
- 🔧 支持按组织过滤

#### 2.4 现象-原因关联
- ✨ 关联时记录权重（默认为 1）
- ✨ 支持手动调整权重
- ✨ 按权重排序显示关联原因

### 3. API 服务层修改

#### 3.1 类型定义 (src/types/index.ts)
- 更新所有相关接口定义
- 添加新字段的类型声明

#### 3.2 Mock API (src/api/)
- 更新 Mock 数据结构
- 增加多组织示例数据
- 增加树状原因示例数据

### 4. 业务逻辑增强

#### 4.1 多组织数据隔离
- 集团级数据（orgId = null）对所有工厂可见
- 工厂级数据仅对本工厂可见
- 数据选择器自动过滤：本工厂数据 + 集团级数据

#### 4.2 原因树操作
- 支持添加根原因和子原因
- 支持拖拽调整层级（可选）
- 删除父原因时提示处理子原因

#### 4.3 高频推荐逻辑
- 高频原因在选择器中优先显示
- 列表支持按高频筛选
- 统计分析时突出高频原因

## Impact

### 受影响的前端文件

- `src/types/index.ts` - 更新类型定义
- `src/views/inspection-model/DefectPhenomenonList.vue` - 不良现象页面
- `src/views/inspection-model/DefectCauseList.vue` - 不良原因页面（重点修改）
- `src/views/inspection-model/DefectCauseEdit.vue` - 不良原因编辑页面
- `src/api/defectManagement.ts` - API 服务层（新建或更新）

### 受影响的后端

- 需要更新数据库表结构（添加新字段）
- 需要更新 API 接口（支持新字段）
- 需要数据迁移脚本（为现有数据设置默认值）

### 用户体验提升

- ✅ 支持多工厂场景，数据隔离清晰
- ✅ 支持深度根因分析（5Why）
- ✅ 智能推荐高频原因，提高录入效率
- ✅ 积累企业质量知识库

### 不包含的功能（留待后续迭代）

- ❌ FMEA 关联功能
- ❌ 严重等级自动升级流程
- ❌ 智能推荐算法优化
- ❌ Measurement 类别补充
