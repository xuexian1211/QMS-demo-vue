# 实现任务清单

## 1. 数据模型和类型定义修改

- [ ] 1.1 更新 `DefectCategory` 接口，添加 `orgId` 字段
- [ ] 1.2 更新 `DefectPhenomenon` 接口，添加 `orgId` 字段
- [ ] 1.3 更新 `DefectCause` 接口，添加 `orgId`, `parentId`, `isHighFrequency` 字段
- [ ] 1.4 更新 `PhenomenonCauseMapping` 接口，添加 `orgId`, `weight` 字段
- [ ] 1.5 在 `src/types/index.ts` 中更新所有相关类型定义

## 2. 数据库迁移（后端）

- [ ] 2.1 编写数据库迁移脚本 - 添加新字段
- [ ] 2.2 更新唯一性约束（orgId + code）
- [ ] 2.3 添加外键约束（parentId → DefectCause.id）
- [ ] 2.4 为现有数据设置默认值（orgId=NULL, parentId=NULL, isHighFrequency=false, weight=1）
- [ ] 2.5 执行迁移并验证数据完整性

## 3. API 服务层开发

- [ ] 3.1 创建 `src/api/defectManagement.ts` 统一 API 服务
- [ ] 3.2 实现缺陷分类 API（支持多组织过滤）
- [ ] 3.3 实现不良现象 API（支持多组织过滤）
- [ ] 3.4 实现不良原因 API（支持树形结构查询）
- [ ] 3.5 实现原因树构建函数 `buildTree()`
- [ ] 3.6 更新 Mock 数据，添加多组织和树状结构示例

## 4. 不良现象页面修改

- [ ] 4.1 在表单中添加组织选择器组件
- [ ] 4.2 在列表中添加"所属组织"列
- [ ] 4.3 实现按组织过滤功能
- [ ] 4.4 在关联原因表格中添加"权重"列
- [ ] 4.5 支持手动调整权重（InputNumber 组件）
- [ ] 4.6 实现按权重排序显示

## 5. 不良原因页面重构（重点）

- [ ] 5.1 **重构左侧树** - 从 5M 分类改为原因层级树
- [ ] 5.2 实现树节点操作按钮（添加子原因/编辑/删除）
- [ ] 5.3 添加"添加根原因"按钮
- [ ] 5.4 实现树节点高频标记显示（⭐图标）
- [ ] 5.5 在表单中添加父原因选择器（TreeSelect）
- [ ] 5.6 在表单中添加"高频原因"开关（Switch）
- [ ] 5.7 在表单中添加组织选择器
- [ ] 5.8 实现按组织过滤原因树
- [ ] 5.9 实现删除父原因时的子原因处理逻辑
- [ ] 5.10 更新列表显示高频标记

## 6. 不良原因编辑页面修改

- [ ] 6.1 添加父原因选择字段
- [ ] 6.2 添加高频标记开关
- [ ] 6.3 添加组织选择器
- [ ] 6.4 实现表单验证规则
- [ ] 6.5 更新保存逻辑（处理新字段）

## 7. 业务逻辑实现

- [ ] 7.1 实现多组织数据过滤逻辑（集团级 + 本工厂）
- [ ] 7.2 实现原因树构建算法
- [ ] 7.3 实现高频原因优先排序逻辑
- [ ] 7.4 实现权重排序逻辑
- [ ] 7.5 实现删除父原因的级联处理

## 8. 样式和 UI 优化

- [ ] 8.1 优化原因树节点样式（高频标记图标）
- [ ] 8.2 优化组织选择器样式
- [ ] 8.3 优化权重输入框样式
- [ ] 8.4 添加提示信息（Tooltip）
- [ ] 8.5 优化空状态显示

## 9. 测试和验证

- [ ] 9.1 **多组织功能测试** - 验证数据隔离
- [ ] 9.2 **原因树功能测试** - 验证添加/删除/展开
- [ ] 9.3 **高频推荐测试** - 验证标记和排序
- [ ] 9.4 **权重功能测试** - 验证设置和排序
- [ ] 9.5 **边界情况测试** - 删除父原因、空数据等

## 10. 文档更新

- [ ] 10.1 更新用户使用文档
- [ ] 10.2 更新开发者文档（API 说明）
- [ ] 10.3 编写数据库迁移说明
- [ ] 10.4 更新 README（如有需要）

## 完成度统计

- **总任务数**: 50 项
- **已完成**: 25 项
- **进行中**: 0 项
- **待开始**: 25 项

## 优先级说明

### P0（必须完成）
- Task 1: 数据模型修改
- Task 2: 数据库迁移
- Task 3: API 服务层
- Task 5: 不良原因页面重构
- Task 9: 测试验证

### P1（重要）
- Task 4: 不良现象页面修改
- Task 6: 不良原因编辑页面
- Task 7: 业务逻辑

### P2（可选）
- Task 8: 样式优化
- Task 10: 文档更新

## 依赖关系

```
Task 1 (类型定义) 
  ↓
Task 2 (数据库迁移) → Task 3 (API 服务)
  ↓                      ↓
Task 4, 5, 6 (前端页面修改)
  ↓
Task 7 (业务逻辑)
  ↓
Task 9 (测试验证)
  ↓
Task 10 (文档更新)
```

## 预估工作量

- **开发时间**: 2-3 周
- **测试时间**: 3-5 天
- **总计**: 约 3 周

## 风险和注意事项

1. **数据迁移风险** - 现有数据需要仔细处理，建议先在测试环境验证
2. **唯一性约束变更** - 可能影响现有数据，需要提前检查冲突
3. **原因树重构** - 左侧树的重构是较大改动，需要充分测试
4. **用户培训** - 新增多组织和树状结构，需要培训用户
