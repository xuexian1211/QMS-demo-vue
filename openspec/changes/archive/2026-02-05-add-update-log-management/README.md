# 系统更新日志管理 - OpenSpec 提案

## 提案概述
本提案旨在为 QMS 系统新增完整的更新日志管理功能,帮助用户了解系统的最新变化和新功能,同时为开发团队提供自动化的变更记录机制。

## 核心功能
1. **更新日志 CRUD 管理** - 支持创建、查看、编辑、删除、发布更新日志
2. **导航栏快速访问** - 在消息通知按钮旁边新增更新日志入口(📝图标)
3. **富文本编辑支持** - 提供强大的富文本编辑器和 Markdown 模式
4. **OpenSpec 自动生成** - 提案归档时自动生成更新日志草稿和设计文档
5. **功能设计文档关联** - 每条更新日志可关联详细的设计文档,按角色(前端/后端/测试)划分任务
6. **设计任务状态管理** - 支持跟踪任务进度,标记完成状态,可视化依赖关系
7. **设计文档导出** - 支持导出为 Markdown/PDF 格式,便于团队成员离线阅读
8. **消息通知集成** - 新更新日志发布时推送通知给用户
9. **权限和多组织支持** - 完整的权限控制和多组织数据隔离

## 提案文件结构
```
openspec/changes/add-update-log-management/
├── proposal.md           # 提案说明(Why, What, Impact)
├── tasks.md              # 实现任务清单(13 个阶段,100+ 子任务)
├── design.md             # 技术设计文档(9 个架构决策、风险评估、迁移计划)
├── README.md             # 本文件,提案概览
└── specs/                # Spec deltas
    ├── update-log-management/
    │   └── spec.md       # 新增能力:更新日志管理(15 个需求,50+ 场景)
    └── system-management/
        └── spec.md       # 修改能力:系统导航栏布局

```

## 提案状态
- ✅ **已创建** - 2026-02-04
- ✅ **已验证** - 通过 `openspec validate --strict` 验证
- ⏳ **待审批** - 等待产品和技术团队审查
- ⏳ **待实施** - 审批通过后进入开发阶段

## 受影响的能力(Capabilities)
- **新增能力**: `update-log-management` - 完整的更新日志管理系统
- **修改能力**: `system-management` - 导航栏布局扩展

## 技术栈
- **前端**: Vue 3 + TypeScript + Ant Design Vue
- **富文本编辑器**: wangEditor 5
- **后端**: Spring Boot 3 (接口设计中)
- **自动化脚本**: Node.js (解析 OpenSpec proposal.md)

## 关键设计决策
1. **数据模型**: 包含版本号、内容类型、状态流转、审计字段等完整信息
2. **富文本编辑器**: 选择 wangEditor 5(轻量、易用、支持 TypeScript)
3. **状态流转**: 草稿 → 已发布 → 已归档(简单清晰的状态机)
4. **自动生成策略**: 通过 Node.js 脚本解析 proposal.md 和 tasks.md 并调用 API 创建
5. **权限设计**: 管理员可创建/编辑/发布,普通用户只读
6. **设计文档数据模型**: 支持按角色(前端/后端/测试)划分任务,包含状态、工时、依赖关系
7. **tasks.md 自动解析**: 通过关键词匹配自动分类任务角色,解析依赖关系
8. **设计文档展示**: 在详情页按角色 Tab 展示,支持任务状态切换和进度统计
9. **文档导出**: 支持 Markdown 和 PDF 格式导出,按角色筛选导出

## 实施计划
### Phase 1: 核心 CRUD 功能(优先级:高)
- 数据模型定义
- 后端 API 接口
- 前端列表和编辑页面
- 基础权限控制

**预计工时**: 5-7 个工作日

### Phase 2: OpenSpec 自动生成(优先级:中)
- 创建 Node.js 脚本
- 解析 proposal.md 和 tasks.md
- API 集成测试

**预计工时**: 2-3 个工作日

### Phase 3: 消息通知集成(优先级:中)
- 扩展通知 Store
- 实现未读徽章
- 通知推送机制

**预计工时**: 2-3 个工作日

### Phase 4: 优化和增强(优先级:低)
- UI/UX 优化
- 性能优化
- 文档完善

**预计工时**: 2-3 个工作日

**总预计工时**: 11-16 个工作日

## 验收标准
- [ ] 所有 CRUD 功能正常工作
- [ ] 导航栏更新日志按钮可见且功能正常
- [ ] 富文本编辑器支持常见格式和 Markdown 模式
- [ ] OpenSpec 归档脚本可以成功生成更新日志草稿
- [ ] **OpenSpec 归档脚本可以正确解析 tasks.md 并生成设计文档**
- [ ] **更新日志详情页正确显示关联的设计文档**
- [ ] **按角色筛选 Tab 正常工作(前端/后端/测试)**
- [ ] **任务状态切换功能正常(待办/进行中/已完成)**
- [ ] **任务依赖关系可视化正确显示**
- [ ] **设计文档导出为 Markdown/PDF 格式正常**
- [ ] 新更新日志发布时触发消息通知
- [ ] 权限控制正确,普通用户无法创建/编辑
- [ ] 多组织数据隔离正常工作
- [ ] 通过所有单元测试和集成测试
- [ ] 代码符合项目规范,通过 TypeScript 检查
- [ ] UI 符合 JNPF 设计规范

## 使用示例

### 手动创建更新日志
```typescript
// 1. 访问更新日志管理页面
router.push('/system/update-log')

// 2. 点击"新增"按钮
// 3. 填写表单
{
  version: 'v1.3.0',
  title: '新增质量报告导出功能',
  content: '<h2>新功能</h2><ul><li>支持导出 PDF 格式报告</li><li>支持批量导出</li></ul>',
  contentType: 'html',
  updateType: 'feature',
  affectedModules: ['质量报告', '文档管理']
}

// 4. 保存草稿或直接发布
```

### 自动生成更新日志
```bash
# OpenSpec 提案归档后执行
npm run generate:update-log integrate-plm-system

# 输出示例:
# ✅ 更新日志草稿已生成
# ID: 20260204-001
# 版本号: v1.2.0
# 标题: PLM 系统集成
# 管理链接: http://localhost:5173/system/update-log/20260204-001
```

## 文档链接
- [提案说明 (proposal.md)](./proposal.md)
- [实现任务 (tasks.md)](./tasks.md)
- [技术设计 (design.md)](./design.md)
- [更新日志管理需求 (specs/update-log-management/spec.md)](./specs/update-log-management/spec.md)
- [系统管理需求变更 (specs/system-management/spec.md)](./specs/system-management/spec.md)

## 风险和缓解措施
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 富文本编辑器性能问题 | 中 | 限制内容长度,提供 Markdown 备选方案 |
| OpenSpec 自动生成质量低 | 中 | 默认生成草稿,人工审核后发布 |
| 前后端接口不一致 | 高 | 先定义接口类型,使用 Mock 数据并行开发 |
| 权限设计不完善 | 中 | 初期简化权限,后续迭代优化 |

## 开放问题
1. 是否需要支持更新日志的多语言版本? - **决定**: 第一阶段仅支持中文
2. 是否需要支持更新日志评论功能? - **决定**: 保留到后续迭代
3. 是否需要邮件通知新更新日志? - **决定**: 保留到后续迭代
4. OpenSpec 归档脚本何时触发? - **决定**: 提供手动和 Git hook 两种方式

## 下一步行动
1. ✅ 创建 OpenSpec 提案文档
2. ✅ 运行 `openspec validate --strict` 验证提案
3. ⏳ 提交提案供团队审查
4. ⏳ 收集反馈并修改提案
5. ⏳ 审批通过后开始实施
6. ⏳ 按照 tasks.md 逐步完成开发任务
7. ⏳ 测试和验收
8. ⏳ 归档提案并更新 specs/

## 联系方式
如有任何问题或建议,请联系:
- **提案创建者**: Antigravity AI Assistant
- **创建时间**: 2026-02-04
- **项目**: QMS-demo (舜富质量管理系统)
